.PHONY: all clean build build-frontend build-backend dev test install help

# é¡¹ç›®ä¿¡æ¯
APP_NAME=searcher
VERSION?=$(shell git describe --tags --always --dirty 2>/dev/null || echo "dev")
BUILD_TIME=$(shell date -u '+%Y-%m-%d_%H:%M:%S')
GIT_COMMIT=$(shell git rev-parse --short HEAD 2>/dev/null || echo "unknown")

# æ„å»ºç›®å½•
BUILD_DIR=build
FRONTEND_DIR=web
FRONTEND_DIST=$(FRONTEND_DIR)/dist
BACKEND_MAIN=cmd/server/main.go

# Go ç¼–è¯‘å‚æ•°
GOOS?=$(shell go env GOOS)
GOARCH?=$(shell go env GOARCH)
LDFLAGS=-ldflags "\
	-s -w \
	-X main.Version=$(VERSION) \
	-X main.BuildTime=$(BUILD_TIME) \
	-X main.GitCommit=$(GIT_COMMIT)"

# é»˜è®¤ç›®æ ‡
all: clean build

## help: æ˜¾ç¤ºå¸®åŠ©ä¿¡æ¯
help:
	@echo "PropertyGuru Auto Searcher - Build Commands"
	@echo ""
	@echo "Usage:"
	@echo "  make [target]"
	@echo ""
	@echo "Targets:"
	@echo "  all              - æ¸…ç†å¹¶æ„å»ºå®Œæ•´åº”ç”¨ï¼ˆé»˜è®¤ï¼‰"
	@echo "  build            - æ„å»ºå‰ç«¯å’Œåç«¯ï¼Œç”Ÿæˆå•ä¸€äºŒè¿›åˆ¶æ–‡ä»¶"
	@echo "  build-frontend   - ä»…æ„å»ºå‰ç«¯ï¼ˆVite buildï¼‰"
	@echo "  build-backend    - ä»…æ„å»ºåç«¯ï¼ˆGo build with embedï¼‰"
	@echo "  dev              - å¼€å‘æ¨¡å¼ï¼ˆå‰ç«¯ Vite dev + åç«¯ Go runï¼‰"
	@echo "  clean            - æ¸…ç†æ„å»ºäº§ç‰©"
	@echo "  test             - è¿è¡Œæµ‹è¯•"
	@echo "  install          - å®‰è£…å‰ç«¯ä¾èµ–"
	@echo "  help             - æ˜¾ç¤ºæ­¤å¸®åŠ©ä¿¡æ¯"
	@echo ""
	@echo "Examples:"
	@echo "  make build                    # æ„å»ºç”Ÿäº§ç‰ˆæœ¬"
	@echo "  make build GOOS=linux         # äº¤å‰ç¼–è¯‘ Linux ç‰ˆæœ¬"
	@echo "  make build VERSION=v1.0.0     # æŒ‡å®šç‰ˆæœ¬å·"
	@echo ""

## build: æ„å»ºå®Œæ•´åº”ç”¨ï¼ˆå‰ç«¯ + åç«¯ï¼‰
build: build-frontend build-backend
	@echo "âœ… Build completed: $(BUILD_DIR)/$(APP_NAME)"
	@echo "ğŸ“¦ Version: $(VERSION)"
	@echo "ğŸ•’ Build Time: $(BUILD_TIME)"
	@echo "ğŸ“ Git Commit: $(GIT_COMMIT)"
	@ls -lh $(BUILD_DIR)/$(APP_NAME)

## build-frontend: æ„å»ºå‰ç«¯é™æ€èµ„æº
build-frontend:
	@echo "ğŸ¨ Building frontend..."
	@if [ ! -d "$(FRONTEND_DIR)/node_modules" ]; then \
		echo "ğŸ“¦ Installing frontend dependencies..."; \
		cd $(FRONTEND_DIR) && npm install; \
	fi
	@cd $(FRONTEND_DIR) && npm run build
	@echo "âœ… Frontend build completed: $(FRONTEND_DIST)"

## build-backend: æ„å»ºåç«¯äºŒè¿›åˆ¶æ–‡ä»¶ï¼ˆåµŒå…¥å‰ç«¯ï¼‰
build-backend:
	@echo "ğŸ”¨ Building backend with embedded frontend..."
	@mkdir -p $(BUILD_DIR)
	@if [ ! -d "$(FRONTEND_DIST)" ]; then \
		echo "âš ï¸  Frontend dist not found, building frontend first..."; \
		$(MAKE) build-frontend; \
	fi
	@echo "ğŸ“¦ Embedding frontend assets..."
	@mkdir -p cmd/server/web/dist
	@cp -r web/dist/* cmd/server/web/dist/
	@GOOS=$(GOOS) GOARCH=$(GOARCH) go build $(LDFLAGS) -tags embed \
		-o $(BUILD_DIR)/$(APP_NAME) ./cmd/server
	@rm -rf cmd/server/web
	@echo "âœ… Backend build completed"

## install: å®‰è£…å‰ç«¯ä¾èµ–
install:
	@echo "ğŸ“¦ Installing frontend dependencies..."
	@cd $(FRONTEND_DIR) && npm install
	@echo "âœ… Dependencies installed"

## dev: å¼€å‘æ¨¡å¼ï¼ˆä¸åµŒå…¥å‰ç«¯ï¼‰
dev:
	@echo "ğŸš€ Starting development mode..."
	@echo "Frontend: http://localhost:3000"
	@echo "Backend: http://localhost:8080"
	@echo ""
	@echo "Start backend with: go run cmd/server/main.go"
	@echo "Start frontend with: cd web && npm run dev"

## clean: æ¸…ç†æ„å»ºäº§ç‰©
clean:
	@echo "ğŸ§¹ Cleaning build artifacts..."
	@rm -rf $(BUILD_DIR)
	@rm -rf $(FRONTEND_DIST)
	@rm -rf $(FRONTEND_DIR)/node_modules
	@rm -rf cmd/server/web
	@echo "âœ… Clean completed"

## test: è¿è¡Œæµ‹è¯•
test:
	@echo "ğŸ§ª Running tests..."
	@go test -v -race -coverprofile=coverage.out ./...
	@echo "âœ… Tests completed"

# äº¤å‰ç¼–è¯‘ç›®æ ‡
## build-linux: æ„å»º Linux amd64 ç‰ˆæœ¬
build-linux:
	@$(MAKE) build GOOS=linux GOARCH=amd64

## build-linux-arm64: æ„å»º Linux arm64 ç‰ˆæœ¬
build-linux-arm64:
	@$(MAKE) build GOOS=linux GOARCH=arm64

## build-darwin: æ„å»º macOS amd64 ç‰ˆæœ¬
build-darwin:
	@$(MAKE) build GOOS=darwin GOARCH=amd64

## build-darwin-arm64: æ„å»º macOS arm64 ç‰ˆæœ¬
build-darwin-arm64:
	@$(MAKE) build GOOS=darwin GOARCH=arm64

## build-windows: æ„å»º Windows amd64 ç‰ˆæœ¬
build-windows:
	@$(MAKE) build GOOS=windows GOARCH=amd64

## build-all: æ„å»ºæ‰€æœ‰å¹³å°ç‰ˆæœ¬
build-all: clean
	@echo "ğŸŒ Building for all platforms..."
	@$(MAKE) build-frontend
	@$(MAKE) build-linux
	@mv $(BUILD_DIR)/$(APP_NAME) $(BUILD_DIR)/$(APP_NAME)-linux-amd64
	@$(MAKE) build-linux-arm64
	@mv $(BUILD_DIR)/$(APP_NAME) $(BUILD_DIR)/$(APP_NAME)-linux-arm64
	@$(MAKE) build-darwin
	@mv $(BUILD_DIR)/$(APP_NAME) $(BUILD_DIR)/$(APP_NAME)-darwin-amd64
	@$(MAKE) build-darwin-arm64
	@mv $(BUILD_DIR)/$(APP_NAME) $(BUILD_DIR)/$(APP_NAME)-darwin-arm64
	@$(MAKE) build-windows
	@mv $(BUILD_DIR)/$(APP_NAME) $(BUILD_DIR)/$(APP_NAME)-windows-amd64.exe
	@echo "âœ… All platforms built"
	@ls -lh $(BUILD_DIR)/

# Docker æ„å»º
## docker-build: æ„å»º Docker é•œåƒ
docker-build:
	@echo "ğŸ³ Building Docker image..."
	@docker build -t $(APP_NAME):$(VERSION) .
	@docker tag $(APP_NAME):$(VERSION) $(APP_NAME):latest
	@echo "âœ… Docker image built: $(APP_NAME):$(VERSION)"

## docker-run: è¿è¡Œ Docker å®¹å™¨
docker-run:
	@docker run --rm -p 8080:8080 --env-file .env $(APP_NAME):latest
